# 每日寄信說明

本文件說明每日美股統整與台股建議的寄信流程、檔案與設定。

---

## 一、每日需執行的檔案

### 主程式：`daily_us_tw_email.py`

這是**每日寄信的主程式**，可每日執行。

### 一鍵執行：`schedule_daily_email.bat`

雙擊此批次檔，會執行 `daily_us_tw_email.py --send`，直接寄出信件。

---

## 二、執行方式

### 1. 雙擊批次檔（建議）

```
雙擊 schedule_daily_email.bat
```

- 會自動寄出信件
- 信件內容會儲存至 `stock/{當日日期}_建議.txt`

### 2. 命令列

```bash
# 預覽內容（不寄出）
python daily_us_tw_email.py --preview

# 直接寄出（不詢問）
python daily_us_tw_email.py --send

# 互動模式（會問是否寄出）
python daily_us_tw_email.py
```

---

## 三、建議執行時間

| 時段 | 說明 |
|------|------|
| **美東收盤後** | 約台灣凌晨 5:30 後 |
| **台股開盤前** | 約台灣早上 9:00 前 |

此時 yfinance 已有最新美股收盤價，報告內容較準確。

---

## 四、環境設定

### 1. Python 依賴

```bash
pip install -r requirements.txt
```

### 2. Gmail 寄信設定（樹莓派版：已寫入程式）

寄件者與收件者已直接寫入 `daily_us_tw_email.py`：

| 變數 | 說明 |
|------|------|
| `GMAIL_SENDER` | 寄件者 Gmail（gish1040403@gmail.com） |
| `GMAIL_APP_PASSWORD` | Gmail 應用程式密碼 |
| `RECIPIENT` | 收件者信箱（s07362022@gmail.com） |

使用 `smtp.ehlo()` → `smtp.starttls()` → `smtp.login()` → `smtp.send_message()` 流程，port 587。

**注意**：若更換密碼，請於程式中更新 `GMAIL_APP_PASSWORD`。

---

## 五、信件內容結構

每日報告包含六個部分：

1. **20 日波動率**：市場波動程度
2. **今日閥值**：大跌/大漲判定門檻（動態）
3. **昨日美股收盤**：QQQ 收盤價、漲跌幅、判定
4. **今日台股建議**：依美股表現給出標的（3 個月優先 + 交集）
5. **歷史策略表**：最近 3 個月回測
6. **過去半年歷史回測表**：半年回測數據

---

## 六、儲存位置

| 項目 | 路徑 |
|------|------|
| 信件文字 | `stock/{YYYY-MM-DD}_建議.txt` |
| 範例 | `stock/2026-02-12_建議.txt` |

每次執行會覆蓋當日檔案，保留最新內容。

---

## 七、排程自動化（選用）

若希望每日固定時間自動執行，可使用：

### Windows 工作排程器

1. 開啟「工作排程器」
2. 建立基本工作
3. 觸發條件：每日，設定時間（例如 06:00）
4. 動作：啟動程式
   - 程式：`python`
   - 參數：`daily_us_tw_email.py --send`
   - 起始於：`F:\代碼\202602`

### 注意

- 排程執行時需確保已設定 `GMAIL_USER` 與 `GMAIL_APP_PASSWORD`
- 建議將環境變數設為「系統」或「使用者」層級，讓排程可讀取

---

## 八、常見問題

### Q：寄信失敗？

檢查：
1. `GMAIL_USER`、`GMAIL_APP_PASSWORD` 是否正確
2. 是否使用應用程式密碼（非登入密碼）
3. 網路連線是否正常

### Q：報價不是最新？

yfinance 使用最近一個美股交易日的收盤價。若在美股盤中或週末執行，會是前一交易日數據。

### Q：可以每天跑嗎？

可以。`daily_us_tw_email.py` 設計為可每天執行，每次會產生當日報告並儲存。
